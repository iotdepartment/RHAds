@model Slide

@{
    ViewData["Title"] = "Imagenes";
}

<h2>Imágenes del Slide: @Model.Titulo</h2>

<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#modalAddImage">
    Agregar Imagen
</button>

<table id="tablaImagenes" class="table table-striped table-bordered pt-2">
    <thead class="table-dark">
        <tr>
            <th class="text-center">Vista previa</th>
            <th class="text-center">Descripción</th>
            <th class="text-center">Orden</th>
            <th class="text-center">Activo</th>
            <th class="text-center">Acciones</th>
            <th class="text-center" style="width:40px;">Mover</th>
        </tr>
    </thead>

    <tbody id="sortableImages" class="text-center">
        @foreach (var img in Model.SlideImages.OrderBy(x => x.Orden))
        {
            <tr data-id="@img.ImageId">
                <td><img src="@img.RutaImagen" style="height:80px" /></td>
                <td>@img.Descripcion</td>
                <td>@img.Orden</td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input"
                               type="checkbox"
                               onchange="toggleActivo(@img.ImageId, this.checked)"
                               @(img.Activo ? "checked" : "")>
                    </div>
                </td>
                <td>
                    <button class="btn btn-warning btn-sm rounded-pill" onclick="openEditImage(@img.ImageId)">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-danger btn-sm rounded-pill" onclick="openDeleteImage(@img.ImageId)">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </td>
                <td class="drag-handle" style="cursor:grab;">
                    <i class="bi bi-list"></i>
                </td>
            </tr>
        }
    </tbody>
</table>

@await Html.PartialAsync("Partials/_ModalAddImage", Model.SlideId)
@await Html.PartialAsync("Partials/_ModalEditImage")
@await Html.PartialAsync("Partials/_ModalDeleteImage")

<!-- SOLO ESTO SE NECESITA -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

@section Scripts {

    <script>
        new DataTable('#tablaImagenes', {
            ordering: false
        });
    </script>

    <script>
        new Sortable(document.getElementById('sortableImages'), {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'bg-warning',

            onEnd: async function () {
                const rows = document.querySelectorAll('#sortableImages tr');
                let orden = [];

                rows.forEach((row, index) => {
                    orden.push({
                        imageId: parseInt(row.getAttribute('data-id')),
                        orden: index + 1
                    });
                });

                await fetch('/Admin/UpdateImageOrder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orden)
                });

                rows.forEach((row, index) => {
                    row.children[2].innerText = index + 1;
                });
            }
        });
    </script>

    <script>
        async function toggleActivo(id, estado) {
            const resp = await fetch('/Admin/UpdateImageActivo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageId: id, activo: estado })
            });

            const result = await resp.json();

            if (!resp.ok) {
                alert("Error: " + result.message);
            }
        }
    </script>

}