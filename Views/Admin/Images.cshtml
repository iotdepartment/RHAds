@model Slide

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">


<h2>Imágenes del Slide: @Model.Titulo</h2>

<!-- BOTÓN QUE ABRE EL MODAL -->
<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#modalAddImage">
    Agregar Imagen
</button>

<table id="tablaImagenes" class="table table-striped table-bordered ">
    <thead >
        <tr >
            <th class="text-center">Vista previa</th>
            <th class="text-center">Descripción</th>
            <th class="text-center">Orden</th>
            <th class="text-center">Activo</th>
            <th class="text-center">Acciones</th>
            <th class="text-center" style="width:40px;">Mover</th>
        </tr>
    </thead>
    <tbody id="sortableImages" class="align-items-center justify-content-center text-center">
        @foreach (var img in Model.SlideImages.OrderBy(x => x.Orden))
        {
            <tr data-id="@img.ImageId" class="">
                <td><img src="@img.RutaImagen" style="height:80px" /></td>
                <td>@img.Descripcion</td>
                <td>@img.Orden</td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox"
                               onchange="toggleActivo(@img.ImageId, this.checked)"
                               @(img.Activo ? "checked" : "")>
                    </div>
                </td>
                <td>
                    <button class="btn btn-warning btn-sm rounded-pill" onclick="openEditImage(@img.ImageId)"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-danger btn-sm rounded-pill" onclick="openDeleteImage(@img.ImageId)"><i class="bi bi-trash-fill"></i></button>
                </td>
                <td class="drag-handle align-items-center align-middle" style="cursor:grab;">
                    <i class="bi bi-list"></i>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- MODAL PARA AGREGAR IMAGEN -->
@await Html.PartialAsync("Partials/_ModalAddImage", Model.SlideId)
@await Html.PartialAsync("Partials/_ModalEditImage")
@await Html.PartialAsync("Partials/_ModalDeleteImage")
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
        new DataTable('#tablaImagenes', {
        ordering: false
    });
</script>

<script>
    new Sortable(document.getElementById('sortableImages'), {
        animation: 150,
         handle: '.drag-handle', // ← SOLO se arrastra desde aquí

        ghostClass: 'bg-warning',
        onEnd: async function () {

            // Obtener el nuevo orden
            const rows = document.querySelectorAll('#sortableImages tr');
            let orden = [];

            rows.forEach((row, index) => {
                orden.push({
                    imageId: parseInt(row.getAttribute('data-id')),
                    orden: index + 1
                });
            });

            // Enviar al servidor
            await fetch('/Admin/UpdateImageOrder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orden)
            });

            // Actualizar columna Orden visualmente
            rows.forEach((row, index) => {
                row.children[2].innerText = index + 1;
            });
        }
    });
</script>

<script>
    async function toggleActivo(id, estado) {
        const resp = await fetch('/Admin/UpdateImageActivo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imageId: id, activo: estado })
        });

        const result = await resp.json();

        if (!resp.ok) {
            alert("Error: " + result.message);
        }
    }
</script>