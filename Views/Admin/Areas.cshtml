@using RHAds.Models.Areas
@model IEnumerable<Area>

@{
    ViewData["Title"] = "Areas";
}

<h2>Áreas</h2>

<!-- BOTÓN QUE ABRE EL MODAL DE CREAR -->
<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#modalCreateArea">
    Crear Área
</button>

<table id="tablaAreas" class="table table-striped table-bordered pt-2">
    <thead class="table-dark">
        <tr>
            <th class="text-center">Nombre</th>
            <th class="text-center">Descripción</th>
            <th class="text-center">Activo</th>
            <th class="text-center">Actions</th>
            <th class="text-center">Actions</th>

        </tr>
    </thead>
    <tbody>
        @foreach (var a in Model)
        {
            <tr data-id="@a.AreaId">

                <td class="text-center area-nombre">@a.Nombre</td>

                <td class="text-center area-descripcion">@a.Descripcion</td>

                <td class="text-center area-activo">
                    <div class="form-check form-switch">
                        <input class="form-check-input"
                               type="checkbox"
                               onchange="toggleActivoArea(@a.AreaId, this.checked)"
                               @(a.Activo ? "checked" : "")>
                    </div>
                </td>

                <td class="text-center area-actions-1">
                    <a href="/Admin/Slides?areaId=@a.AreaId" class="btn btn-primary btn-sm rounded-pill"><i class="bi bi-file-earmark-easel-fill"></i></a>
                    <a href="/Admin/EditorLayout?areaId=@a.AreaId" class="btn btn-info btn-sm rounded-pill"><i class="bi bi-columns-gap"></i></a>
                    <a href="/Admin/Fullscreen?areaId=@a.AreaId" class="btn btn-dark btn-sm rounded-pill" target="_blank"><i class="bi bi-fullscreen"></i></a>
                </td>

                <td class="text-center area-actions-2">
                    <button class="btn btn-warning btn-sm rounded-pill" onclick="openEditArea(@a.AreaId)">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-danger btn-sm rounded-pill" onclick="openDeleteArea(@a.AreaId, '@a.Nombre')"><i class="bi bi-trash-fill"></i></button>
                </td>

            </tr>
        }
    </tbody>
</table>

<!-- PARTIALS -->
@await Html.PartialAsync("Partials/_ModalCreateArea")
@await Html.PartialAsync("Partials/_ModalEditArea")
@await Html.PartialAsync("Partials/_ModalDeleteArea")
@section Scripts {

    <script>
        let tablaAreas;

        document.addEventListener("DOMContentLoaded", function () {
            tablaAreas = new DataTable('#tablaAreas', {
                ordering: false
            });
        });

        /* ============================
           CREAR ÁREA (CORREGIDO)
        ============================ */
             async function guardarArea() {
            const data = {
                nombre: document.getElementById("areaNombre").value,
                descripcion: document.getElementById("areaDescripcion").value,
                activo: document.getElementById("areaActivo").checked
            };

            const resp = await fetch('/Admin/CreateAreaFetch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await resp.json();

            if (resp.ok) {
                // Ocultar modal
                bootstrap.Modal.getInstance(document.getElementById('modalCreateArea')).hide();

                // Agregar nueva fila a la tabla
                tablaAreas.row.add($(result.html)).draw(false);

                // ✅ Mostrar toast de éxito
                showToast(result.message || "Área creada correctamente", "success");

                // Limpiar formulario
                document.getElementById("areaNombre").value = "";
                document.getElementById("areaDescripcion").value = "";
                document.getElementById("areaActivo").checked = true;
            } else {
                // ❌ Mostrar toast de error
                showToast(result.message || "Error al crear el área", "error");
            }
        }

        /* ============================
           ABRIR MODAL DE EDICIÓN
        ============================ */
        async function openEditArea(id) {
            const resp = await fetch('/Admin/GetArea?id=' + id);
            const area = await resp.json();

            // Ojo: revisa si tu JSON devuelve areaId o AreaId
            document.getElementById("editAreaId").value = area.areaId ?? area.AreaId;
            document.getElementById("editNombre").value = area.nombre ?? area.Nombre;
            document.getElementById("editDescripcion").value = area.descripcion ?? area.Descripcion;

            new bootstrap.Modal(document.getElementById('modalEditArea')).show();
        }

        /* ============================
           ABRIR MODAL DE ELIMINAR
        ============================ */
        function openDeleteArea(id, nombre) {
            document.getElementById("deleteAreaId").value = id;
            document.getElementById("deleteAreaName").textContent = nombre;

            new bootstrap.Modal(document.getElementById("modalDeleteArea")).show();
        }

        /* ============================
           ELIMINAR ÁREA
        ============================ */
              async function confirmDeleteArea() {
            try {
                const id = document.getElementById("deleteAreaId").value;

                const resp = await fetch('/Admin/DeleteArea', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });

                const result = await resp.json();

                if (result.success) {
                    // Ocultar modal
                    bootstrap.Modal.getInstance(document.getElementById("modalDeleteArea")).hide();

                    // Eliminar la fila de la tabla
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) tablaAreas.row(row).remove().draw();

                    // ✅ Toast verde
                    showToast(result.message || "Área eliminada correctamente", "success");
                } else {
                    // ❌ Toast rojo
                    showToast(result.message || "No se pudo eliminar el área", "error");
                }
            } catch (err) {
                // Error de red
                showToast("Error de conexión con el servidor", "error");
            }
        }
        /* ============================
           SWITCH ACTIVO
        ============================ */
        async function toggleActivoArea(id, estado) {
            const resp = await fetch('/Admin/UpdateAreaActivo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ areaId: id, activo: estado })
            });

            const result = await resp.json();

            if (!resp.ok) {
                showSuccessToast("Error: " + result.message);
            }
        }

    </script>

}