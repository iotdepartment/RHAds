import{DDResizableHandle}from"./dd-resizable-handle";import{DDBaseImplement}from"./dd-base-impl";import{Utils}from"./utils";import{DDManager}from"./dd-manager";class DDResizable extends DDBaseImplement{constructor(e,t={}){super(),this.el=e,this.option=t,this.rectScale={x:1,y:1},this._ui=()=>{const e=this.el.parentElement;var t=e.getBoundingClientRect(),i={width:this.originalRect.width,height:this.originalRect.height+this.scrolled,left:this.originalRect.left,top:this.originalRect.top-this.scrolled},i=this.temporalRect||i;return{position:{left:(i.left-t.left)*this.rectScale.x,top:(i.top-t.top)*this.rectScale.y},size:{width:i.width*this.rectScale.x,height:i.height*this.rectScale.y}}},this._mouseOver=this._mouseOver.bind(this),this._mouseOut=this._mouseOut.bind(this),this.enable(),this._setupAutoHide(this.option.autoHide),this._setupHandlers()}on(e,t){super.on(e,t)}off(e){super.off(e)}enable(){super.enable(),this.el.classList.remove("ui-resizable-disabled"),this._setupAutoHide(this.option.autoHide)}disable(){super.disable(),this.el.classList.add("ui-resizable-disabled"),this._setupAutoHide(!1)}destroy(){this._removeHandlers(),this._setupAutoHide(!1),delete this.el,super.destroy()}updateOption(t){var e=t.handles&&t.handles!==this.option.handles,i=t.autoHide&&t.autoHide!==this.option.autoHide;return Object.keys(t).forEach(e=>this.option[e]=t[e]),e&&(this._removeHandlers(),this._setupHandlers()),i&&this._setupAutoHide(this.option.autoHide),this}_setupAutoHide(e){return e?(this.el.classList.add("ui-resizable-autohide"),this.el.addEventListener("mouseover",this._mouseOver),this.el.addEventListener("mouseout",this._mouseOut)):(this.el.classList.remove("ui-resizable-autohide"),this.el.removeEventListener("mouseover",this._mouseOver),this.el.removeEventListener("mouseout",this._mouseOut),DDManager.overResizeElement===this&&delete DDManager.overResizeElement),this}_mouseOver(e){DDManager.overResizeElement||DDManager.dragElement||(DDManager.overResizeElement=this).el.classList.remove("ui-resizable-autohide")}_mouseOut(e){DDManager.overResizeElement===this&&(delete DDManager.overResizeElement,this.el.classList.add("ui-resizable-autohide"))}_setupHandlers(){return this.handlers=this.option.handles.split(",").map(e=>e.trim()).map(t=>new DDResizableHandle(this.el,t,{start:e=>{this._resizeStart(e)},stop:e=>{this._resizeStop(e)},move:e=>{this._resizing(e,t)}})),this}_resizeStart(e){this.sizeToContent=Utils.shouldSizeToContent(this.el.gridstackNode,!0),this.originalRect=this.el.getBoundingClientRect(),this.scrollEl=Utils.getScrollElement(this.el),this.scrollY=this.scrollEl.scrollTop,this.scrolled=0,this.startEvent=e,this._setupHelper(),this._applyChange();e=Utils.initEvent(e,{type:"resizestart",target:this.el});return this.option.start&&this.option.start(e,this._ui()),this.el.classList.add("ui-resizable-resizing"),this.triggerEvent("resizestart",e),this}_resizing(e,t){this.scrolled=this.scrollEl.scrollTop-this.scrollY,this.temporalRect=this._getChange(e,t),this._applyChange();t=Utils.initEvent(e,{type:"resize",target:this.el});return this.option.resize&&this.option.resize(t,this._ui()),this.triggerEvent("resize",t),this}_resizeStop(e){e=Utils.initEvent(e,{type:"resizestop",target:this.el});return this._cleanHelper(),this.option.stop&&this.option.stop(e),this.el.classList.remove("ui-resizable-resizing"),this.triggerEvent("resizestop",e),delete this.startEvent,delete this.originalRect,delete this.temporalRect,delete this.scrollY,delete this.scrolled,this}_setupHelper(){this.elOriginStyleVal=DDResizable._originStyleProp.map(e=>this.el.style[e]),this.parentOriginStylePosition=this.el.parentElement.style.position;var e=this.el.parentElement,e=Utils.getValuesFromTransformedElement(e);return this.rectScale={x:e.xScale,y:e.yScale},getComputedStyle(this.el.parentElement).position.match(/static/)&&(this.el.parentElement.style.position="relative"),this.el.style.position="absolute",this.el.style.opacity="0.8",this}_cleanHelper(){return DDResizable._originStyleProp.forEach((e,t)=>{this.el.style[e]=this.elOriginStyleVal[t]||null}),this.el.parentElement.style.position=this.parentOriginStylePosition||null,this}_getChange(e,t){var i=this.startEvent;const s={width:this.originalRect.width,height:this.originalRect.height+this.scrolled,left:this.originalRect.left,top:this.originalRect.top-this.scrolled};var h=e.clientX-i.clientX,e=this.sizeToContent?0:e.clientY-i.clientY;let l,r;-1<t.indexOf("e")?s.width+=h:-1<t.indexOf("w")&&(s.width-=h,s.left+=h,l=!0),-1<t.indexOf("s")?s.height+=e:-1<t.indexOf("n")&&(s.height-=e,s.top+=e,r=!0);i=this._constrainSize(s.width,s.height,l,r);return Math.round(s.width)!==Math.round(i.width)&&(-1<t.indexOf("w")&&(s.left+=s.width-i.width),s.width=i.width),Math.round(s.height)!==Math.round(i.height)&&(-1<t.indexOf("n")&&(s.top+=s.height-i.height),s.height=i.height),s}_constrainSize(e,t,i,s){var h=this.option,i=(i?h.maxWidthMoveLeft:h.maxWidth)||Number.MAX_SAFE_INTEGER,l=h.minWidth/this.rectScale.x||e,s=(s?h.maxHeightMoveUp:h.maxHeight)||Number.MAX_SAFE_INTEGER,h=h.minHeight/this.rectScale.y||t;return{width:Math.min(i,Math.max(l,e)),height:Math.min(s,Math.max(h,t))}}_applyChange(){let s={left:0,top:0,width:0,height:0};if("absolute"===this.el.style.position){const i=this.el.parentElement;var{left:e,top:t}=i.getBoundingClientRect();s={left:e,top:t,width:0,height:0}}return this.temporalRect&&Object.keys(this.temporalRect).forEach(e=>{var t=this.temporalRect[e],i="width"===e||"left"===e?this.rectScale.x:"height"===e||"top"===e?this.rectScale.y:1;this.el.style[e]=(t-s[e])*i+"px"}),this}_removeHandlers(){return this.handlers.forEach(e=>e.destroy()),delete this.handlers,this}}DDResizable._originStyleProp=["width","height","position","left","top","opacity","zIndex"];export{DDResizable};