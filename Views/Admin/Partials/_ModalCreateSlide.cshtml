@using RHAds.Models.Areas
@{
    var areaId = (int)Model;
    var areas = ViewBag.Areas as List<Area>;
}

<div class="modal fade" id="modalCreateSlide" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Crear Slide</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="slideAreaId" value="@Model" />

                <div class="mb-3">
                    <label class="form-label">Título</label>
                    <input id="slideTitulo" class="form-control" placeholder="Título del slide">
                </div>

                <div class="mb-3">
                    <label class="form-label">Orden</label>
                    <input id="slideOrden" type="number" class="form-control" placeholder="Orden">
                </div>

                <div class="form-check mb-3">
                    <input id="slideActivo" type="checkbox" class="form-check-input" checked>
                    <label class="form-check-label">Activo</label>
                </div>

                <div class="form-check mb-3">
                    <input id="slideEsGlobal" type="checkbox" class="form-check-input" onchange="toggleAreaDestino()">
                    <label class="form-check-label">Es Global</label>
                </div>

                <div class="mb-3">
                    <label class="form-label">Color Cabecera</label>
                    <input id="slideColor" type="color" class="form-control form-control-color" />
                </div>

                <div class="mb-3" id="areaDestinoContainer" style="display:none;">
                    <label class="form-label">Área destino</label>
                    <select id="slideAreaDestinoId" class="form-select">
                        <option value="">-- Selecciona un área --</option>
                        @if (areas != null)
                        {
                            foreach (var area in areas.Where(a => a.EsInstitucional))
                            {
                                <option value="@area.AreaId">@area.Nombre</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarSlide()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleAreaDestino() {
        const esGlobal = document.getElementById("slideEsGlobal").checked;
        const container = document.getElementById("areaDestinoContainer");
        if (esGlobal) {
            container.style.display = "block";
        } else {
            container.style.display = "none";
            document.getElementById("slideAreaDestinoId").value = "";
        }
    }

       async function guardarSlide() {
        const esGlobal = document.getElementById("slideEsGlobal").checked;
        const areaDestinoId = document.getElementById("slideAreaDestinoId").value;

        if (esGlobal && (!areaDestinoId || areaDestinoId === "")) {
            showToast("Debes seleccionar un área destino cuando el slide es global.", "error");
            return;
        }

        const data = {
            areaId: parseInt(document.getElementById("slideAreaId").value),
            titulo: document.getElementById("slideTitulo").value,
            orden: parseInt(document.getElementById("slideOrden").value),
            activo: document.getElementById("slideActivo").checked,
            esGlobal: esGlobal,
            colorCabecera: document.getElementById("slideColor").value,
            areaDestinoId: esGlobal ? parseInt(areaDestinoId) : null
        };

        try {
            const resp = await fetch('/Admin/CreateSlideFetch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await resp.json();
            if (resp.ok && result.success) {
                showToast(result.message, "success");
                bootstrap.Modal.getInstance(document.getElementById('modalCreateSlide')).hide();

                // ✅ refrescar la tabla con los datos nuevos
                table.ajax.reload(null, false);

                // ✅ limpiar campos del modal
                document.getElementById("slideTitulo").value = "";
                document.getElementById("slideOrden").value = "";
                document.getElementById("slideActivo").checked = true;
                document.getElementById("slideEsGlobal").checked = false;
                document.getElementById("slideColor").value = "#000000";
                document.getElementById("slideAreaDestinoId").value = "";
                toggleAreaDestino();
            } else {
                showToast("Error: " + result.message, "error");
            }
        } catch (err) {
            showToast("Error de conexión con el servidor", "error");
        }
    }
</script>