import{Utils}from"./utils";class GridStackEngine{constructor(t={}){this.addedNodes=[],this.removedNodes=[],this.defaultColumn=12,this.column=t.column||this.defaultColumn,this.column>this.defaultColumn&&(this.defaultColumn=this.column),this.maxRow=t.maxRow,this._float=t.float,this.nodes=t.nodes||[],this.onChange=t.onChange}batchUpdate(t=!0,i=!0){return!!this.batchMode===t||((this.batchMode=t)?(this._prevFloat=this._float,this._float=!0,this.cleanNodes(),this.saveInitial()):(this._float=this._prevFloat,delete this._prevFloat,i&&this._packNodes(),this._notify())),this}_useEntireRowArea(t,i){return(!this.float||this.batchMode&&!this._prevFloat)&&!this._hasLocked&&(!t._moving||t._skipDown||i.y<=t.y)}_fixCollisions(i,e=i,s,o={}){if(this.sortNodes(-1),!(s=s||this.collide(i,e)))return!1;if(i._moving&&!o.nested&&!this.float&&this.swap(i,s))return!0;let t=e,h=(!this._loading&&this._useEntireRowArea(i,e)&&(t={x:0,w:this.column,y:e.y,h:e.h},s=this.collide(i,t,o.skip)),!1);var n,d={nested:!0,pack:!1};let a=0;for(;s=s||this.collide(i,t,o.skip);){if(a++>2*this.nodes.length)throw new Error("Infinite collide check");let t;if(s.locked||this._loading||i._moving&&!i._skipDown&&e.y>i.y&&!this.float&&(!this.collide(s,{...s,y:i.y},i)||!this.collide(s,{...s,y:e.y-s.h},i))?(i._skipDown=i._skipDown||e.y>i.y,n={...e,y:s.y+s.h,...d},t=!(!this._loading||!Utils.samePos(i,n))||this.moveNode(i,n),(s.locked||this._loading)&&t?Utils.copyPos(e,i):!s.locked&&t&&o.pack&&(this._packNodes(),e.y=s.y+s.h,Utils.copyPos(i,e)),h=h||t):t=this.moveNode(s,{...s,y:e.y+e.h,skip:i,...d}),!t)return h;s=void 0}return h}collide(t,i=t,e){const s=t._id,o=e?._id;return this.nodes.find(t=>t._id!==s&&t._id!==o&&Utils.isIntercepted(t,i))}collideAll(t,i=t,e){const s=t._id,o=e?._id;return this.nodes.filter(t=>t._id!==s&&t._id!==o&&Utils.isIntercepted(t,i))}directionCollideCoverage(t,i,o){if(i.rect&&t._rect){var h,n=t._rect;const a={...i.rect};a.y>n.y?(a.h+=a.y-n.y,a.y=n.y):a.h+=n.y-a.y,a.x>n.x?(a.w+=a.x-n.x,a.x=n.x):a.w+=n.x-a.x;let e,s=.5;for(h of o){if(h.locked||!h._rect)break;var d=h._rect;let t=Number.MAX_VALUE,i=Number.MAX_VALUE;n.y<d.y?t=(a.y+a.h-d.y)/d.h:n.y+n.h>d.y+d.h&&(t=(d.y+d.h-a.y)/d.h),n.x<d.x?i=(a.x+a.w-d.x)/d.w:n.x+n.w>d.x+d.w&&(i=(d.x+d.w-a.x)/d.w);d=Math.min(i,t);d>s&&(s=d,e=h)}return i.collide=e}}cacheRects(i,e,s,o,h,n){return this.nodes.forEach(t=>t._rect={y:t.y*e+s,x:t.x*i+n,w:t.w*i-n-o,h:t.h*e-s-h}),this}swap(e,s){if(!s||s.locked||!e||e.locked)return!1;function t(){var t=s.x,i=s.y;return s.x=e.x,s.y=e.y,e.h!=s.h?(e.x=t,e.y=s.y+s.h):(e.w!=s.w?e.x=s.x+s.w:e.x=t,e.y=i),e._dirty=s._dirty=!0}let i;if(e.w===s.w&&e.h===s.h&&(e.x===s.x||e.y===s.y)&&(i=Utils.isTouching(e,s)))return t();var o;if(!1!==i)return e.w===s.w&&e.x===s.x&&(i=i||Utils.isTouching(e,s))?(s.y<e.y&&(o=e,e=s,s=o),t()):!1!==i?!(e.h!==s.h||e.y!==s.y||!(i=i||Utils.isTouching(e,s)))&&(s.x<e.x&&(o=e,e=s,s=o),t()):void 0}isAreaEmpty(t,i,e,s){return!this.collide({x:t||0,y:i||0,w:e||1,h:s||1})}compact(o="compact",t=!0){if(0===this.nodes.length)return this;t&&this.sortNodes();var t=this.batchMode,i=(t||this.batchUpdate(),this._inColumnResize);i||(this._inColumnResize=!0);const e=this.nodes;return this.nodes=[],e.forEach((t,i,e)=>{let s;t.locked||(t.autoPosition=!0,"list"===o&&i&&(s=e[i-1])),this.addNode(t,!1,s)}),i||delete this._inColumnResize,t||this.batchUpdate(!1),this}set float(t){this._float!==t&&(this._float=t||!1,t||this._packNodes()._notify())}get float(){return this._float||!1}sortNodes(t=1){return this.nodes=Utils.sort(this.nodes,t),this}_packNodes(){return this.batchMode||(this.sortNodes(),this.float?this.nodes.forEach(i=>{if(!i._updating&&void 0!==i._orig&&i.y!==i._orig.y){let t=i.y;for(;t>i._orig.y;)--t,this.collide(i,{x:i.x,y:t,w:i.w,h:i.h})||(i._dirty=!0,i.y=t)}}):this.nodes.forEach((t,i)=>{if(!t.locked)for(;0<t.y;){var e=0===i?0:t.y-1;if(!(0===i||!this.collide(t,{x:t.x,y:e,w:t.w,h:t.h})))break;t._dirty=t.y!==e,t.y=e}})),this}prepareNode(i,t){i._id=i._id??GridStackEngine._idSeq++;var e=i.id;if(e){let t=1;for(;this.nodes.find(t=>t.id===i.id&&t!==i);)i.id=e+"_"+t++}void 0!==i.x&&void 0!==i.y&&null!==i.x&&null!==i.y||(i.autoPosition=!0);var s={x:0,y:0,w:1,h:1};return Utils.defaults(i,s),i.autoPosition||delete i.autoPosition,i.noResize||delete i.noResize,i.noMove||delete i.noMove,Utils.sanitizeMinMax(i),"string"==typeof i.x&&(i.x=Number(i.x)),"string"==typeof i.y&&(i.y=Number(i.y)),"string"==typeof i.w&&(i.w=Number(i.w)),"string"==typeof i.h&&(i.h=Number(i.h)),isNaN(i.x)&&(i.x=s.x,i.autoPosition=!0),isNaN(i.y)&&(i.y=s.y,i.autoPosition=!0),isNaN(i.w)&&(i.w=s.w),isNaN(i.h)&&(i.h=s.h),this.nodeBoundFix(i,t),i}nodeBoundFix(t,i){var e=t._orig||Utils.copyPos({},t),s=(t.maxW&&(t.w=Math.min(t.w||1,t.maxW)),t.maxH&&(t.h=Math.min(t.h||1,t.maxH)),t.minW&&(t.w=Math.max(t.w||1,t.minW)),t.minH&&(t.h=Math.max(t.h||1,t.minH)),(t.x||0)+(t.w||1)>this.column);if(s&&this.column<this.defaultColumn&&!this._inColumnResize&&!this.skipCacheUpdate&&null!=t._id&&-1===this.findCacheLayout(t,this.defaultColumn)){const o={...t};o.autoPosition||void 0===o.x?(delete o.x,delete o.y):o.x=Math.min(this.defaultColumn-1,o.x),o.w=Math.min(this.defaultColumn,o.w||1),this.cacheOneLayout(o,this.defaultColumn)}return t.w>this.column?t.w=this.column:t.w<1&&(t.w=1),this.maxRow&&t.h>this.maxRow?t.h=this.maxRow:t.h<1&&(t.h=1),t.x<0&&(t.x=0),t.y<0&&(t.y=0),t.x+t.w>this.column&&(i?t.w=this.column-t.x:t.x=this.column-t.w),this.maxRow&&t.y+t.h>this.maxRow&&(i?t.h=this.maxRow-t.y:t.y=this.maxRow-t.h),Utils.samePos(t,e)||(t._dirty=!0),this}getDirtyNodes(t){return t?this.nodes.filter(t=>t._dirty&&!Utils.samePos(t,t._orig)):this.nodes.filter(t=>t._dirty)}_notify(t){if(this.batchMode||!this.onChange)return this;t=(t||[]).concat(this.getDirtyNodes());return this.onChange(t),this}cleanNodes(){return this.batchMode||this.nodes.forEach(t=>{delete t._dirty,delete t._lastTried}),this}saveInitial(){return this.nodes.forEach(t=>{t._orig=Utils.copyPos({},t),delete t._dirty}),this._hasLocked=this.nodes.some(t=>t.locked),this}restoreInitial(){return this.nodes.forEach(t=>{t._orig&&!Utils.samePos(t,t._orig)&&(Utils.copyPos(t,t._orig),t._dirty=!0)}),this._notify(),this}findEmptyPosition(i,e=this.nodes,s=this.column,o){let h=!1;for(let t=o?o.y*s+(o.x+o.w):0;!h;++t){var n=t%s,d=Math.floor(t/s);if(!(n+i.w>s)){const a={x:n,y:d,w:i.w,h:i.h};e.find(t=>Utils.isIntercepted(a,t))||(i.x===n&&i.y===d||(i._dirty=!0),i.x=n,i.y=d,delete i.autoPosition,h=!0)}}return h}addNode(i,t=!1,e){var s=this.nodes.find(t=>t._id===i._id);if(s)return s;this._inColumnResize?this.nodeBoundFix(i):this.prepareNode(i),delete i._temporaryRemoved,delete i._removeDOM;let o;return i.autoPosition&&this.findEmptyPosition(i,this.nodes,this.column,e)&&(delete i.autoPosition,o=!0),this.nodes.push(i),t&&this.addedNodes.push(i),o||this._fixCollisions(i),this.batchMode||this._packNodes()._notify(),i}removeNode(i,t=!0,e=!1){return this.nodes.find(t=>t._id===i._id)&&(e&&this.removedNodes.push(i),t&&(i._removeDOM=!0),this.nodes=this.nodes.filter(t=>t._id!==i._id),i._isAboutToRemove||this._packNodes(),this._notify([i])),this}removeAll(t=!0,i=!0){if(delete this._layouts,!this.nodes.length)return this;t&&this.nodes.forEach(t=>t._removeDOM=!0);t=this.nodes;return this.removedNodes=i?t:[],this.nodes=[],this._notify(t)}moveNodeCheck(i,t){if(!this.changedPosConstrain(i,t))return!1;if(t.pack=!0,!this.maxRow)return this.moveNode(i,t);let e;const s=new GridStackEngine({column:this.column,float:this.float,nodes:this.nodes.map(t=>t._id===i._id?e={...t}:{...t})});if(!e)return!1;var o=s.moveNode(e,t)&&s.getRow()<=Math.max(this.getRow(),this.maxRow);if(!o&&!t.resizing&&t.collide){t=t.collide.el.gridstackNode;if(this.swap(i,t))return this._notify(),!0}return!!o&&(s.nodes.filter(t=>t._dirty).forEach(i=>{const t=this.nodes.find(t=>t._id===i._id);t&&(Utils.copyPos(t,i),t._dirty=!0)}),this._notify(),!0)}willItFit(t){if(delete t._willFitPos,!this.maxRow)return!0;const i=new GridStackEngine({column:this.column,float:this.float,nodes:this.nodes.map(t=>({...t}))}),e={...t};return this.cleanupNode(e),delete e.el,delete e._id,delete e.content,delete e.grid,i.addNode(e),i.getRow()<=this.maxRow&&(t._willFitPos=Utils.copyPos({},e),!0)}changedPosConstrain(t,i){return i.w=i.w||t.w,i.h=i.h||t.h,t.x!==i.x||t.y!==i.y||(t.maxW&&(i.w=Math.min(i.w,t.maxW)),t.maxH&&(i.h=Math.min(i.h,t.maxH)),t.minW&&(i.w=Math.max(i.w,t.minW)),t.minH&&(i.h=Math.max(i.h,t.minH)),t.w!==i.w||t.h!==i.h)}moveNode(i,e){if(!i||!e)return!1;let s;void 0!==e.pack||this.batchMode||(s=e.pack=!0),"number"!=typeof e.x&&(e.x=i.x),"number"!=typeof e.y&&(e.y=i.y),"number"!=typeof e.w&&(e.w=i.w),"number"!=typeof e.h&&(e.h=i.h);var t=i.w!==e.w||i.h!==e.h,o=Utils.copyPos({},i,!0);if(Utils.copyPos(o,e),this.nodeBoundFix(o,t),Utils.copyPos(e,o),!e.forceCollide&&Utils.samePos(i,e))return!1;var t=Utils.copyPos({},i),h=this.collideAll(i,o,e.skip);let n=!0;if(h.length){var d=i._moving&&!e.nested;let t=d?this.directionCollideCoverage(i,e,h):h[0];d&&t&&i.grid?.opts?.subGridDynamic&&!i.grid._isTemp&&(.8<Utils.areaIntercept(e.rect,t._rect)/((h=Utils.area(e.rect))<(d=Utils.area(t._rect))?h:d)&&(t.grid.makeSubGrid(t.el,void 0,i),t=void 0)),t?n=!this._fixCollisions(i,o,t,e):(n=!1,s&&delete e.pack)}return n&&!Utils.samePos(i,o)&&(i._dirty=!0,Utils.copyPos(i,o)),e.pack&&this._packNodes()._notify(),!Utils.samePos(i,t)}getRow(){return this.nodes.reduce((t,i)=>Math.max(t,i.y+i.h),0)}beginUpdate(t){return t._updating||(t._updating=!0,delete t._skipDown,this.batchMode||this.saveInitial()),this}endUpdate(){const t=this.nodes.find(t=>t._updating);return t&&(delete t._updating,delete t._skipDown),this}save(e=!0,s,t){var i=this._layouts?.length||0;let o;i&&(t?t!==this.column&&(o=this._layouts[t]):this.column!==i-1&&(o=this._layouts[i-1]));const h=[];return this.sortNodes(),this.nodes.forEach(i=>{var t=o?.find(t=>t._id===i._id),t={...i,...t||{}};Utils.removeInternalForSave(t,!e),s&&s(i,t),h.push(t)}),h}layoutsNodesChange(i){return!this._layouts||this._inColumnResize||this._layouts.forEach((e,t)=>{if(!e||t===this.column)return this;if(t<this.column)this._layouts[t]=void 0;else{const s=t/this.column;i.forEach(i=>{if(i._orig){const t=e.find(t=>t._id===i._id);t&&(0<=t.y&&i.y!==i._orig.y&&(t.y+=i.y-i._orig.y),i.x!==i._orig.x&&(t.x=Math.round(i.x*s)),i.w!==i._orig.w&&(t.w=Math.round(i.w*s)))}})}}),this}columnChanged(i,e,t="moveScale"){if(!this.nodes.length||!e||i===e)return this;const s="compact"===t||"list"===t;s&&this.sortNodes(1),e<i&&this.cacheLayout(this.nodes,i),this.batchUpdate();let o=[],h=s?this.nodes:Utils.sort(this.nodes,-1);if(i<e&&this._layouts){const d=this._layouts[e]||[];var n=this._layouts.length-1;!d.length&&i!==n&&this._layouts[n]?.length&&(i=n,this._layouts[n].forEach(i=>{const t=h.find(t=>t._id===i._id);t&&(s||i.autoPosition||(t.x=i.x??t.x,t.y=i.y??t.y),t.w=i.w??t.w,null!=i.x&&void 0!==i.y||(t.autoPosition=!0))})),d.forEach(i=>{var t=h.findIndex(t=>t._id===i._id);if(-1!==t){const e=h[t];s?e.w=i.w:((i.autoPosition||isNaN(i.x)||isNaN(i.y))&&this.findEmptyPosition(i,o),i.autoPosition||(e.x=i.x??e.x,e.y=i.y??e.y,e.w=i.w??e.w,o.push(e)),h.splice(t,1))}})}if(s)this.compact(t,!1);else{if(h.length)if("function"==typeof t)t(e,i,o,h);else{const a=s||"none"===t?1:e/i,r="move"===t||"moveScale"===t,l="scale"===t||"moveScale"===t;h.forEach(t=>{t.x=1===e?0:r?Math.round(t.x*a):Math.min(t.x,e-1),t.w=1===e||1===i?1:l?Math.round(t.w*a)||1:Math.min(t.w,e),o.push(t)}),h=[]}o=Utils.sort(o,-1),this._inColumnResize=!0,this.nodes=[],o.forEach(t=>{this.addNode(t,!1),delete t._orig})}return this.nodes.forEach(t=>delete t._orig),this.batchUpdate(!1,!s),delete this._inColumnResize,this}cacheLayout(t,i,e=!1){const s=[];return t.forEach((i,t)=>{var e;void 0===i._id&&(e=i.id?this.nodes.find(t=>t.id===i.id):void 0,i._id=e?._id??GridStackEngine._idSeq++),s[t]={x:i.x,y:i.y,w:i.w,_id:i._id}}),this._layouts=!e&&this._layouts||[],this._layouts[i]=s,this}cacheOneLayout(t,i){t._id=t._id??GridStackEngine._idSeq++;const e={x:t.x,y:t.y,w:t.w,_id:t._id};!t.autoPosition&&void 0!==t.x||(delete e.x,delete e.y,t.autoPosition&&(e.autoPosition=!0)),this._layouts=this._layouts||[],this._layouts[i]=this._layouts[i]||[];t=this.findCacheLayout(t,i);return-1===t?this._layouts[i].push(e):this._layouts[i][t]=e,this}findCacheLayout(i,t){return this._layouts?.[t]?.findIndex(t=>t._id===i._id)??-1}removeNodeFromLayoutCache(i){if(this._layouts)for(let t=0;t<this._layouts.length;t++){var e=this.findCacheLayout(i,t);-1!==e&&this._layouts[t].splice(e,1)}}cleanupNode(t){for(const i in t)"_"===i[0]&&"_id"!==i&&delete t[i];return this}}GridStackEngine._idSeq=0;export{GridStackEngine};