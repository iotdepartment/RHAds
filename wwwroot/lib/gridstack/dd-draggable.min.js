import{DDManager}from"./dd-manager";import{Utils}from"./utils";import{DDBaseImplement}from"./dd-base-impl";import{isTouch,touchend,touchmove,touchstart,pointerdown}from"./dd-touch";const skipMouseDown='input,textarea,button,select,option,[contenteditable="true"],.ui-resizable-handle';class DDDraggable extends DDBaseImplement{constructor(e,t={}){super(),this.el=e,this.option=t,this.dragTransform={xScale:1,yScale:1,xOffset:0,yOffset:0};var i=t?.handle?.substring(1),s=e.gridstackNode;this.dragEls=!i||e.classList.contains(i)?[e]:s?.subGrid?[e.querySelector(t.handle)||e]:Array.from(e.querySelectorAll(t.handle)),0===this.dragEls.length&&(this.dragEls=[e]),this._mouseDown=this._mouseDown.bind(this),this._mouseMove=this._mouseMove.bind(this),this._mouseUp=this._mouseUp.bind(this),this._keyEvent=this._keyEvent.bind(this),this.enable()}on(e,t){super.on(e,t)}off(e){super.off(e)}enable(){!1!==this.disabled&&(super.enable(),this.dragEls.forEach(e=>{e.addEventListener("mousedown",this._mouseDown),isTouch&&(e.addEventListener("touchstart",touchstart),e.addEventListener("pointerdown",pointerdown))}),this.el.classList.remove("ui-draggable-disabled"))}disable(e=!1){!0!==this.disabled&&(super.disable(),this.dragEls.forEach(e=>{e.removeEventListener("mousedown",this._mouseDown),isTouch&&(e.removeEventListener("touchstart",touchstart),e.removeEventListener("pointerdown",pointerdown))}),e||this.el.classList.add("ui-draggable-disabled"))}destroy(){this.dragTimeout&&window.clearTimeout(this.dragTimeout),delete this.dragTimeout,this.mouseDownEvent&&this._mouseUp(this.mouseDownEvent),this.disable(!0),delete this.el,delete this.helper,delete this.option,super.destroy()}updateOption(t){return Object.keys(t).forEach(e=>this.option[e]=t[e]),this}_mouseDown(t){if(!DDManager.mouseHandled)return 0!==t.button||(!(this.dragEls.find(e=>e===t.target)||!t.target.closest(skipMouseDown))||(!(!this.option.cancel||!t.target.closest(this.option.cancel))||(this.mouseDownEvent=t,delete this.dragging,delete DDManager.dragElement,delete DDManager.dropElement,document.addEventListener("mousemove",this._mouseMove,{capture:!0,passive:!0}),document.addEventListener("mouseup",this._mouseUp,!0),isTouch&&(t.currentTarget.addEventListener("touchmove",touchmove),t.currentTarget.addEventListener("touchend",touchend)),t.preventDefault(),document.activeElement&&document.activeElement.blur(),DDManager.mouseHandled=!0)))}_callDrag(e){this.dragging&&(e=Utils.initEvent(e,{target:this.el,type:"drag"}),this.option.drag&&this.option.drag(e,this.ui()),this.triggerEvent("drag",e))}_mouseMove(e){var t,i=this.mouseDownEvent;return this.lastDrag=e,this.dragging?(this._dragFollow(e),DDManager.pauseDrag?(t=Number.isInteger(DDManager.pauseDrag)?DDManager.pauseDrag:100,this.dragTimeout&&window.clearTimeout(this.dragTimeout),this.dragTimeout=window.setTimeout(()=>this._callDrag(e),t)):this._callDrag(e)):3<Math.abs(e.x-i.x)+Math.abs(e.y-i.y)&&(this.dragging=!0,(t=(DDManager.dragElement=this).el.gridstackNode?.grid)?DDManager.dropElement=t.el.ddElement.ddDroppable:delete DDManager.dropElement,this.helper=this._createHelper(),this._setupHelperContainmentStyle(),this.dragTransform=Utils.getValuesFromTransformedElement(this.helperContainment),this.dragOffset=this._getDragOffset(e,this.el,this.helperContainment),this._setupHelperStyle(e),i=Utils.initEvent(e,{target:this.el,type:"dragstart"}),this.option.start&&this.option.start(i,this.ui()),this.triggerEvent("dragstart",i),document.addEventListener("keydown",this._keyEvent)),!0}_mouseUp(e){var t;document.removeEventListener("mousemove",this._mouseMove,!0),document.removeEventListener("mouseup",this._mouseUp,!0),isTouch&&e.currentTarget&&(e.currentTarget.removeEventListener("touchmove",touchmove,!0),e.currentTarget.removeEventListener("touchend",touchend,!0)),this.dragging&&(delete this.dragging,delete this.el.gridstackNode?._origRotate,document.removeEventListener("keydown",this._keyEvent),DDManager.dropElement?.el===this.el.parentElement&&delete DDManager.dropElement,this.helperContainment.style.position=this.parentOriginStylePosition||null,this.helper!==this.el&&this.helper.remove(),this._removeHelperStyle(),t=Utils.initEvent(e,{target:this.el,type:"dragstop"}),this.option.stop&&this.option.stop(t),this.triggerEvent("dragstop",t),DDManager.dropElement&&DDManager.dropElement.drop(e)),delete this.helper,delete this.mouseDownEvent,delete DDManager.dragElement,delete DDManager.dropElement,delete DDManager.mouseHandled,e.preventDefault()}_keyEvent(e){const t=this.el.gridstackNode,i=t?.grid||DDManager.dropElement?.el?.gridstack;"Escape"===e.key?(t&&t._origRotate&&(t._orig=t._origRotate,delete t._origRotate),i?.cancelDrag(),this._mouseUp(this.mouseDownEvent)):t&&i&&("r"===e.key||"R"===e.key)&&Utils.canBeRotated(t)&&(t._origRotate=t._origRotate||{...t._orig},delete t._moving,i.setAnimation(!1).rotate(t.el,{top:-this.dragOffset.offsetTop,left:-this.dragOffset.offsetLeft}).setAnimation(),t._moving=!0,this.dragOffset=this._getDragOffset(this.lastDrag,t.el,this.helperContainment),this.helper.style.width=this.dragOffset.width+"px",this.helper.style.height=this.dragOffset.height+"px",Utils.swap(t._orig,"w","h"),delete t._rect,this._mouseMove(this.lastDrag))}_createHelper(){let e=this.el;return"function"==typeof this.option.helper?e=this.option.helper(this.el):"clone"===this.option.helper&&(e=Utils.cloneNode(this.el)),e.parentElement||Utils.appendTo(e,"parent"===this.option.appendTo?this.el.parentElement:this.option.appendTo),this.dragElementOriginStyle=DDDraggable.originStyleProp.map(e=>this.el.style[e]),e}_setupHelperStyle(e){this.helper.classList.add("ui-draggable-dragging"),this.el.gridstackNode?.grid?.el.classList.add("grid-stack-dragging");const t=this.helper.style;return t.pointerEvents="none",t.width=this.dragOffset.width+"px",t.height=this.dragOffset.height+"px",t.willChange="left, top",t.position="fixed",this._dragFollow(e),t.transition="none",setTimeout(()=>{this.helper&&(t.transition=null)},0),this}_removeHelperStyle(){if(this.helper.classList.remove("ui-draggable-dragging"),this.el.gridstackNode?.grid?.el.classList.remove("grid-stack-dragging"),!(this.helper?.gridstackNode)?._isAboutToRemove&&this.dragElementOriginStyle){const t=this.helper,e=this.dragElementOriginStyle.transition||null;t.style.transition=this.dragElementOriginStyle.transition="none",DDDraggable.originStyleProp.forEach(e=>t.style[e]=this.dragElementOriginStyle[e]||null),setTimeout(()=>t.style.transition=e,50)}return delete this.dragElementOriginStyle,this}_dragFollow(e){const t=0,i=0,s=this.helper.style;var r=this.dragOffset;s.left=(e.clientX+r.offsetLeft-t)*this.dragTransform.xScale+"px",s.top=(e.clientY+r.offsetTop-i)*this.dragTransform.yScale+"px"}_setupHelperContainmentStyle(){return this.helperContainment=this.helper.parentElement,"fixed"!==this.helper.style.position&&(this.parentOriginStylePosition=this.helperContainment.style.position,getComputedStyle(this.helperContainment).position.match(/static/)&&(this.helperContainment.style.position="relative")),this}_getDragOffset(e,t,i){let s=0,r=0;i&&(s=this.dragTransform.xOffset,r=this.dragTransform.yOffset);i=t.getBoundingClientRect();return{left:i.left,top:i.top,offsetLeft:-e.clientX+i.left-s,offsetTop:-e.clientY+i.top-r,width:i.width*this.dragTransform.xScale,height:i.height*this.dragTransform.yScale}}ui(){const e=this.el.parentElement;var t=e.getBoundingClientRect(),i=this.helper.getBoundingClientRect();return{position:{top:(i.top-t.top)*this.dragTransform.yScale,left:(i.left-t.left)*this.dragTransform.xScale}}}}DDDraggable.originStyleProp=["width","height","transform","transform-origin","transition","pointerEvents","position","left","top","minWidth","willChange"];export{DDDraggable};